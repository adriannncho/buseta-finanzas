// Prisma Schema para la aplicación de gestión de busetas
// Este schema está diseñado para conectarse a una BD PostgreSQL existente

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["transport"]
}

// =====================================================
//  USUARIOS Y AUTENTICACIÓN
// =====================================================
model User {
  id           Int      @id @default(autoincrement())
  fullName     String   @map("full_name") @db.VarChar(150)
  email        String?  @unique @db.VarChar(255)
  nationalId   String   @unique @map("national_id") @db.VarChar(50)
  passwordHash String   @map("password_hash") @db.Text
  role         String   @db.VarChar(20)
  assignedBusId Int?    @map("assigned_bus_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  assignedBus             Bus?                      @relation("AssignedBus", fields: [assignedBusId], references: [id], onDelete: SetNull)
  sessions                Session[]
  invoicesUploaded        Invoice[]                 @relation("InvoiceUploader")
  busExpensesCreated      BusExpense[]              @relation("ExpenseCreator")
  budgetsCreated          Budget[]                  @relation("BudgetCreator")
  auditLogs               AuditLog[]                @relation("AuditActor")
  profitSharingGroupsCreated ProfitSharingGroup[]   @relation("ProfitGroupCreator")
  profitSharingMemberships ProfitSharingMember[]
  expenseCategoriesCreated ExpenseCategory[]        @relation("CategoryCreator")
  routesAsWorker          Route[]                   @relation("RouteWorker")

  @@index([role], map: "idx_users_role")
  @@map("users")
  @@schema("transport")
}

// =====================================================
//  BUSES
// =====================================================
model Bus {
  id            Int      @id @default(autoincrement())
  internalCode  String   @unique @map("internal_code") @db.VarChar(50)
  plateNumber   String?  @map("plate_number") @db.VarChar(20)
  description   String?  @db.Text
  monthlyTarget Decimal? @default(0) @map("monthly_target") @db.Decimal(12, 2)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  assignedWorkers     User[]              @relation("AssignedBus")
  busExpenses         BusExpense[]
  routes              Route[]
  budgets             Budget[]
  profitSharingGroups ProfitSharingGroup[]

  @@map("buses")
  @@schema("transport")
}

// =====================================================
//  FACTURAS
// =====================================================
model Invoice {
  id            Int       @id @default(autoincrement())
  invoiceNumber String?   @map("invoice_number") @db.VarChar(100)
  providerName  String?   @map("provider_name") @db.VarChar(200)
  issueDate     DateTime? @map("issue_date") @db.Date
  totalAmount   Decimal?  @map("total_amount") @db.Decimal(12, 2)
  fileUrl       String    @map("file_url") @db.Text
  mimeType      String?   @map("mime_type") @db.VarChar(100)
  uploadedBy    Int?      @map("uploaded_by")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relaciones
  uploader    User?        @relation("InvoiceUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  busExpenses BusExpense[]

  @@index([issueDate], map: "idx_invoices_issue_date")
  @@map("invoices")
  @@schema("transport")
}

// =====================================================
//  CATEGORÍAS DE GASTOS
// =====================================================
model ExpenseCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?  @db.Text
  isVariable  Boolean  @default(true) @map("is_variable")
  isRequired  Boolean  @default(false) @map("is_required")
  isActive    Boolean  @default(true) @map("is_active")
  createdBy   Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  creator     User?         @relation("CategoryCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  busExpenses BusExpense[]
  budgetItems BudgetItem[]

  @@map("expense_categories")
  @@schema("transport")
}

// =====================================================
//  PRESUPUESTOS
// =====================================================
model Budget {
  id                  Int       @id @default(autoincrement())
  name                String    @db.VarChar(150)
  busId               Int?      @map("bus_id")
  startDate           DateTime  @map("start_date") @db.Date
  endDate             DateTime? @map("end_date") @db.Date
  totalPlannedIncome  Decimal   @default(0) @map("total_planned_income") @db.Decimal(12, 2)
  totalPlannedExpense Decimal   @default(0) @map("total_planned_expense") @db.Decimal(12, 2)
  totalCommitted      Decimal   @default(0) @map("total_committed") @db.Decimal(12, 2)
  totalExecuted       Decimal   @default(0) @map("total_executed") @db.Decimal(12, 2)
  createdBy           Int?      @map("created_by")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  bus         Bus?         @relation(fields: [busId], references: [id], onDelete: SetNull)
  creator     User?        @relation("BudgetCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  budgetItems BudgetItem[]

  @@index([busId, startDate, endDate], map: "idx_budgets_bus_dates")
  @@map("budgets")
  @@schema("transport")
}

model BudgetItem {
  id              Int      @id @default(autoincrement())
  budgetId        Int      @map("budget_id")
  categoryId      Int      @map("category_id")
  plannedAmount   Decimal  @default(0) @map("planned_amount") @db.Decimal(12, 2)
  committedAmount Decimal  @default(0) @map("committed_amount") @db.Decimal(12, 2)
  executedAmount  Decimal  @default(0) @map("executed_amount") @db.Decimal(12, 2)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  budget   Budget          @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@unique([budgetId, categoryId], map: "budget_items_budget_id_category_id_key")
  @@index([budgetId], map: "idx_budget_items_budget")
  @@map("budget_items")
  @@schema("transport")
}

// =====================================================
//  RUTAS
// =====================================================
model Route {
  id            Int      @id @default(autoincrement())
  busId         Int      @map("bus_id")
  workerId      Int      @map("worker_id")
  routeName     String   @map("route_name") @db.VarChar(255)
  routeDate     DateTime @map("route_date") @db.Date
  startTime     DateTime? @map("start_time") @db.Timestamptz(6)
  endTime       DateTime? @map("end_time") @db.Timestamptz(6)
  totalIncome   Decimal  @default(0) @map("total_income") @db.Decimal(12, 2)
  totalExpenses Decimal  @default(0) @map("total_expenses") @db.Decimal(12, 2)
  netIncome     Decimal  @default(0) @map("net_income") @db.Decimal(12, 2)
  notes         String?  @db.Text
  isLocked      Boolean  @default(true) @map("is_locked")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  bus           Bus            @relation(fields: [busId], references: [id], onDelete: Restrict)
  worker        User           @relation("RouteWorker", fields: [workerId], references: [id], onDelete: Restrict)
  routeExpenses RouteExpense[]

  @@index([busId, routeDate], map: "idx_routes_bus_date")
  @@index([workerId, routeDate], map: "idx_routes_worker_date")
  @@index([routeDate], map: "idx_routes_date")
  @@index([isLocked], map: "idx_routes_locked")
  @@map("routes")
  @@schema("transport")
}

model RouteExpense {
  id          Int      @id @default(autoincrement())
  routeId     Int      @map("route_id")
  expenseName String   @map("expense_name") @db.VarChar(100)
  amount      Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relaciones
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId], map: "idx_route_expenses_route")
  @@map("route_expenses")
  @@schema("transport")
}

// =====================================================
//  GASTOS DE BUSES (anteriormente "expenses")
// =====================================================
model BusExpense {
  id          Int      @id @default(autoincrement())
  busId       Int      @map("bus_id")
  categoryId  Int      @map("category_id")
  amount      Decimal  @db.Decimal(12, 2)
  description String?  @db.Text
  expenseDate DateTime @map("expense_date") @db.Date
  createdBy   Int?     @map("created_by")
  invoiceId   Int?     @map("invoice_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  bus      Bus             @relation(fields: [busId], references: [id], onDelete: Restrict)
  category ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  creator  User?           @relation("ExpenseCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  invoice  Invoice?        @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([busId, expenseDate], map: "idx_bus_expenses_bus_date")
  @@index([categoryId], map: "idx_bus_expenses_category")
  @@map("bus_expenses")
  @@schema("transport")
}

// =====================================================
//  SESIONES
// =====================================================
model Session {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  jwtId     String?   @map("jwt_id") @db.VarChar(255)
  ipAddress String?   @map("ip_address") @db.Inet
  userAgent String?   @map("user_agent") @db.Text
  startedAt DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)
  endedAt   DateTime? @map("ended_at") @db.Timestamptz(6)
  isActive  Boolean   @default(true) @map("is_active")

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_sessions_user")
  @@index([isActive], map: "idx_sessions_active")
  @@map("sessions")
  @@schema("transport")
}

// =====================================================
//  AUDITORÍA
// =====================================================
model AuditLog {
  id          Int      @id @default(autoincrement())
  actorUserId Int?     @map("actor_user_id")
  action      String   @db.VarChar(50)
  entityType  String   @map("entity_type") @db.VarChar(50)
  entityId    Int?     @map("entity_id")
  description String?  @db.Text
  metadata    Json?    @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relaciones
  actor User? @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([actorUserId], map: "idx_audit_logs_actor")
  @@index([entityType, entityId], map: "idx_audit_logs_entity")
  @@index([createdAt], map: "idx_audit_logs_created_at")
  @@map("audit_logs")
  @@schema("transport")
}

// =====================================================
//  REPARTO DE GANANCIAS (PROFIT SHARING)
// =====================================================
model ProfitSharingGroup {
  id        Int       @id @default(autoincrement())
  busId     Int       @map("bus_id")
  name      String?   @db.VarChar(150)
  startDate DateTime  @map("start_date") @db.Date
  endDate   DateTime? @map("end_date") @db.Date
  isActive  Boolean   @default(true) @map("is_active")
  createdBy Int?      @map("created_by")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  bus     Bus                   @relation(fields: [busId], references: [id], onDelete: Cascade)
  creator User?                 @relation("ProfitGroupCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  members ProfitSharingMember[]

  @@index([busId, startDate, endDate], map: "idx_profit_sharing_groups_bus_dates")
  @@map("profit_sharing_groups")
  @@schema("transport")
}

model ProfitSharingMember {
  id          Int      @id @default(autoincrement())
  groupId     Int      @map("group_id")
  userId      Int      @map("user_id")
  roleInShare String   @map("role_in_share") @db.VarChar(20)
  percentage  Decimal  @db.Decimal(5, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relaciones
  group ProfitSharingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User               @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([groupId], map: "idx_profit_sharing_members_group")
  @@index([userId], map: "idx_profit_sharing_members_user")
  @@map("profit_sharing_members")
  @@schema("transport")
}
